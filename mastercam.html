<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mastercam Academy · F&P Healthcare</title>
  <meta name="description"
    content="Fisher & Paykel Healthcare · Mastercam Academy training portal with playlist, notes, resources, FAQs, and progress tracking." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] } } },
      darkMode: 'class'
    }
  </script>
  <style>
    :root {
      --brand: #003A8C;
      --brand-dark: #002E6B;
      --brand-50: #E6F0FF;
      --brand-accent: #00A3E0
    }

    .btn {
      padding: .5rem .875rem;
      border-radius: .75rem;
      font-size: .875rem
    }

    .btn-primary {
      background: var(--brand);
      color: white;
    }

    .btn-primary:hover {
      background: var(--brand-dark);
    }

    .focus-ring:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(0, 58, 140, .45);
    }

    .transition-base {
      transition: all 200ms ease;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 min-h-screen">
  <!-- Top bar -->
  <header
    class="sticky top-0 z-40 backdrop-blur bg-white/80 dark:bg-gray-900/80 border-b border-gray-200/70 dark:border-gray-800/70">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-white flex items-center justify-center shadow-sm">
          <img src="Images/osa.png" alt="OSA Logo" class="h-6 w-auto" />
        </div>

        <div>
          <h1 class="text-lg font-semibold leading-tight">Mastercam for OSA</h1>
          <p class="text-xs text-gray-500">Fisher &amp; Paykel Healthcare Technical Skills</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="homepage.html" class="btn border border-gray-200 dark:border-gray-800">← Back to Homepage</a>
        <button id="themeToggle" class="px-3 py-2 rounded-xl text-sm border border-gray-200 dark:border-gray-800">Toggle
          theme</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6 pb-24">
    <!-- Sidebar: playlist + FAQs -->
    <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
      <section class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl">
        <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
          <h3 class="text-base font-semibold">Playlist</h3>
          <div class="text-xs text-gray-500">Progress: <span id="coursePct">0%</span></div>
        </div>
        <div id="playlist" class="p-2"></div>
      </section>

      <section class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl" id="faqCard">
        <div class="p-4 border-b border-gray-200 dark:border-gray-800">
          <h3 class="text-base font-semibold">Lesson FAQs <span id="faqLessonTitle"
              class="text-xs text-gray-500 font-normal">—</span></h3>
        </div>
        <div class="p-4" id="faqList"></div>
      </section>
    </aside>

    <!-- Main content -->
    <section class="lg:col-span-8 xl:col-span-9 space-y-6">
      <article class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-6">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-semibold">Mastercam Training</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">Follow the playlist on the left. Your notes & progress
              save automatically.</p>
          </div>
          <div class="min-w-[220px] w-full sm:w-auto">
            <div class="h-2 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden">
              <div id="courseBar" class="h-full bg-[var(--brand)] transition-all w-0"></div>
            </div>
            <p class="text-xs text-right mt-1 text-gray-500"><span id="coursePctTop">0%</span> complete</p>
          </div>
        </div>
      </article>

      <article class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-6">
        <div class="aspect-video w-full rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
          <div id="playerMount" class="w-full h-full"></div>
        </div>
        <div class="mt-4">
          <div class="flex items-center gap-2">
            <button class="tab-btn btn" data-tab="notes">Lesson Notes</button>
            <button class="tab-btn btn" data-tab="resources">Resources</button>
            <button class="tab-btn btn" data-tab="qa">Q&A</button>
          </div>
          <div class="mt-4 text-sm">
            <section id="tab-notes" class="tab hidden">
              <h3 class="font-medium">Learning objectives</h3>
              <ul id="objectivesList" class="mt-2 list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300">
              </ul>
              <div class="mt-4">
                <label class="block text-xs text-gray-500">Your notes (add anything you like)</label>
                <textarea id="notesBox"
                  class="mt-1 w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-2"
                  rows="6" placeholder="Add arbitrary text or notes for this lesson…"></textarea>
              </div>
            </section>
            <section id="tab-resources" class="tab hidden">
              <h3 class="font-medium">Lesson resources &amp; downloads</h3>
              <ul id="resourceList" class="mt-2 list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300"></ul>
            </section>
            <section id="tab-qa" class="tab hidden">
              <h3 class="font-medium">Q&A (local)</h3>
              <p class="text-gray-600 dark:text-gray-400">Jot down questions to discuss with your mentor.</p>
              <div class="mt-2">
                <textarea id="qaBox"
                  class="mt-1 w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-2"
                  rows="4" placeholder="Questions, roadblocks, ideas…"></textarea>
              </div>
            </section>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-between gap-2 flex-wrap">
          <div class="text-xs text-gray-500">Current lesson: <span id="currentLessonLabel">—</span></div>
          <div class="flex items-center gap-2">
            <button id="markDone" class="btn btn-primary">Mark lesson complete</button>
            <button id="prevLesson" class="btn border border-gray-200 dark:border-gray-800">Prev</button>
            <button id="nextLesson" class="btn border border-gray-200 dark:border-gray-800">Next</button>
          </div>
        </div>
      </article>

      <article class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div>
            <h3 class="text-lg font-semibold">Completion certificate</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400">Unlocks at 100% completion.</p>
          </div>
          <button id="downloadCert" class="btn btn-primary disabled:opacity-40" disabled>Download certificate</button>
        </div>
      </article>
    </section>
  </main>

  <footer class="border-t border-gray-200 dark:border-gray-800 py-8">
    <div
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-xs text-gray-500 flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
      <p>© <span id="year"></span> Fisher & Paykel Healthcare Limited. All rights reserved.</p>
      <p>Contact: <a class="underline" href="mailto:people@company.com">eric.ou@fphcare.co.nz</a></p>
    </div>
  </footer>

  <script>
    // ===== THEME =====
    const themeBtn = document.getElementById('themeToggle');
    if ((localStorage.getItem('theme') || '') === 'dark' || (!localStorage.getItem('theme') && matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
    themeBtn.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== DATA =====
    const DEFAULT_FAQS = [
      { q: 'Do I need prior CNC experience?', a: 'No — we start with UI and stock setup, then build to common 2D toolpaths.' },
      { q: 'Which Mastercam version?', a: 'Recent versions; UI may differ slightly but core concepts transfer.' },
      { q: 'My toolpath doesn’t match the video', a: 'Check units, stock origin, tool library, and chaining direction.' }
    ];

    const LESSON_FAQS = {
      'm1l1': [
        { q: 'Who are the SMEs?', a: 'They are your subject-matter experts for Mastercam.' },
        { q: 'How do I contact them?', a: 'Flick them a message on teams and they will reply ASAP.' }
      ],
      'm1l2': [
        { q: 'The YouTube video is blocked at work', a: 'Open it in a new tab using your corporate browser profile, or request the URL to be allow‑listed by IT.' },
        { q: 'Minimum PC specs?', a: 'Target a modern CPU (8 cores), 16–32 GB RAM, SSD, and a workstation‑class GPU with updated drivers.' }
      ],
      'm1l3': [
        { q: 'How do I reset the Mastercam layout?', a: 'Window → Reset dialog, or reload workspace under Options. The video shows the default workspace.' },
        { q: 'Mouse controls don’t match the video', a: 'Check your Mouse Settings under System Config → Mouse. Enable Zoom About Cursor for similar behavior.' }
      ],
      'm1l4': [
        { q: 'Metric vs Imperial?', a: 'Set Units in the machine group properties. Recreate stock if you switched units after geometry was created.' },
        { q: 'Stock origin differs', a: 'Use the same WCS and origin as the video (top-left of raw stock). Update planes if needed.' }
      ],
      'm2l1': [
        { q: 'My chain won’t select correctly', a: 'Switch selection mode: wireframe vs solid edges. Use the chaining dialog to pick tangent edges.' },
        { q: 'Imported STEP has missing edges', a: 'Run Analyze → Entity properties and Heal geometry, or simplify using Model Prep.' }
      ],
      'm2l2': [
        { q: 'Tool comp causing gouges', a: 'Verify your wear vs control compensation and lead-in/out radius. Start with small entry/exit arcs.' },
        { q: 'Pocket leaves islands', a: 'Enable Island facing or rest material, and confirm containment boundary direction.' }
      ],
      'm2l3': [
        { q: 'Which peck cycle to use?', a: 'Use chip-break for shallow holes and full peck for deep holes. Adjust retract amount per material.' },
        { q: 'Spot drill size?', a: 'Spot to 1.2x–1.5x drill tip diameter for better centering; follow your shop standard.' }
      ],
      'm3l1': [
        { q: 'Verify is slow', a: 'Lower simulation quality or use stock models incrementally between ops.' },
        { q: 'False collisions?', a: 'Confirm holder and shank definitions and set tolerance consistent with part tolerance.' }
      ],
      'm3l2': [
        { q: 'Post outputs wrong codes', a: 'Select the Fanuc post used in the lesson and check control definitions match your machine.' },
        { q: 'DNC upload tips', a: 'Use the shop-approved sender and verify program number + header/footer blocks.' }
      ],
      'm4l1': [
        { q: '3+2 WCS confusion', a: 'Create a plane for each set angle and use Toolplane = Cplane for consistent posting.' },
        { q: 'Fixture collisions', a: 'Add stock + fixture to Verify and define keep-out zones where needed.' }
      ],
      'm4l2': [
        { q: 'Tool axis control basics', a: 'Start with surface normals, then experiment with lead/lag angles within safe limits.' },
        { q: 'Safety limits', a: 'Use machine sim where available and keep rotational limits conservative for first runs.' }
      ]
    };

    const course = {
      modules: [
        {
          id: 'm1',
          title: 'Module 1 · Getting Started',
          lessons: [
            {
              id: 'm1l1',
              title: 'Meet your SMEs',
              dur: '6m',
              embed: `
                <div class="p-4">
                  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    <div class="border border-gray-200 dark:border-gray-800 rounded-xl p-4 bg-white/70 dark:bg-gray-900/40">
                      <img src="Images/profile picture/mitesh.jpg" alt="Mitesh Patel" class="w-14 h-14 rounded-full mb-3 object-cover" />
                      <h4 class="font-semibold">Mitesh Patel</h4>
                      <p class="text-xs text-gray-500">Product Development Engineer</p>
                      <a class="text-sm underline mt-2 inline-block" href="mailto:mitesh.patel@fphcare.co.nz">mitesh.patel@fphcare.co.nz</a>
                    </div>
                    <div class="border border-gray-200 dark:border-gray-800 rounded-xl p-4 bg-white/70 dark:bg-gray-900/40">
                      <div class="w-14 h-14 rounded-full bg-[var(--brand-50)] mb-3"></div>
                      <h4 class="font-semibold">Stephen Hefferman</h4>
                      <p class="text-xs text-gray-500"> Senior Product Development Engineer</p>
                      <a class="text-sm underline mt-2 inline-block" href="mailto:mitesh.patel@fphcare.co.nz">mitesh.patel@fphcare.co.nz</a>
                    </div>
                    <div class="border border-gray-200 dark:border-gray-800 rounded-xl p-4 bg-white/70 dark:bg-gray-900/40">
                      <div class="w-14 h-14 rounded-full bg-[var(--brand-50)] mb-3"></div>
                      <h4 class="font-semibold">Puneet Atwal</h4>
                      <p class="text-xs text-gray-500">Product Development Engineer</p>
                      <a class="text-sm underline mt-2 inline-block" href="mailto:mitesh.patel@fphcare.co.nz">mitesh.patel@fphcare.co.nz</a>
                    </div>
                      <div class="border border-gray-200 dark:border-gray-800 rounded-xl p-4 bg-white/70 dark:bg-gray-900/40">
                      <div class="w-14 h-14 rounded-full bg-[var(--brand-50)] mb-3"></div>
                      <h4 class="font-semibold">Patrick Domett</h4>
                      <p class="text-xs text-gray-500">Senior Systems Specialist</p>
                      <a class="text-sm underline mt-2 inline-block" href="mailto:mitesh.patel@fphcare.co.nz">mitesh.patel@fphcare.co.nz</a>
                    </div>
                  </div>
                </div>
              `,
              objectives: [
                'Know who to contact if you need help with MasterCAM',
              ],
              resources: [{ label: 'None for this section' }],
              faqs: [
                { q: 'How do I reach the right SME?', a: 'Flick them a message on Teams and they will be happy to help ASAP' },
              ]
            },
            {
              id: 'm1l2',
              title: 'Optimisation for PC',
              dur: '7m',
              embed: `<iframe class="w-full h-full" src="https://www.youtube.com/embed/qA7WKMdgXWc" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Configure Windows power/performance settings',
                'Update GPU drivers and set CAD/CAM profiles',
                'Tune Mastercam performance preferences'
              ],
              resources: [{ label: "Log ICT Ticket", href: 'https://fphcare.service-now.com/esc' }],
              faqs: [
                { q: 'Do I need admin rights?', a: 'Driver updates and some settings may require IT assistance.' }
              ]
            },
            {
              id: 'm1l3',
              title: 'Importing and Roughing',
              dur: '10m',
              embed: `<iframe class="w-full h-full" src="https://fphcareonline.sharepoint.com/sites/RDInstitutionalKnowledge/_layouts/15/embed.aspx?UniqueId=0698d5ab-20ed-536b-84ac-0778e5694561&embed=%7B%22ust%22%3Afalse%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create" frameborder="0" scrolling="no" allowfullscreen title="Mastercam Tutorial Video 1 - Importing & Roughing.mp4"></iframe>`,
              objectives: [
                'Understand the Mastercam workspace (Ribbon, Ops Manager, Graphics view)',
                'Use mouse navigation & selection filters effectively'
              ],
              resources: [
                { label: 'MasterCAM Introduction Document - Author: Mitesh Patel (PDF)', href: '#' },
                { label: 'Open in SharePoint (Stream)', href: 'https://fphcareonline.sharepoint.com/sites/RDInstitutionalKnowledge/_layouts/15/embed.aspx?UniqueId=0698d5ab-20ed-536b-84ac-0778e5694561&embed=%7B%22ust%22%3Afalse%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create' }
              ]
            },
            {
              id: 'm1l4',
              title: 'Stock Setup & Units',
              dur: '15m',
              embed: `<iframe class="w-full h-full"src="https://fphcareonline.sharepoint.com/sites/RDInstitutionalKnowledge/_layouts/15/embed.aspx?UniqueId=7e4af678-8aa0-5955-fbe1-3edb6992bed0&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Define stock size & origin',
                'Confirm machine group, WCS, and units'
              ],
              resources: [{ label: 'Setup Checklist (.xlsx)', href: '#' }]
            }
          ]
        },
        {
          id: 'm2',
          title: 'Module 2 · Toolpath Creation',
          lessons: [
            {
              id: 'm2l1',
              title: 'Sketching & Geometry Selection',
              dur: '20m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_GEOM?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Differentiate wireframe vs solid-edge selection',
                'Chain edges and control endpoints/tangency'
              ],
              resources: [{ label: 'Sample part (STEP)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Download the STEP sample part from the resources list.' },
                { q: 'What should I focus on here?', a: 'Clean, unambiguous chains before applying toolpaths.' }
              ]
            },
            {
              id: 'm2l2',
              title: '2D Toolpaths: Contour & Pocket',
              dur: '25m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_2D?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Apply contour and pocket strategies',
                'Tune lead-in/out, compensation, stepdown/stepover'
              ],
              resources: [{ label: 'Sample part (STEP)', href: '#' }, { label: 'Starter tool library (.tooldb)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Use the STEP and tool library from the resources list.' },
                { q: 'What should I focus on here?', a: 'Conservative parameters and correct compensation direction.' }
              ]
            },
            {
              id: 'm2l3',
              title: 'Drilling Cycles',
              dur: '10m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_DRILL?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Choose appropriate peck/chip-break cycles',
                'Sequence spot, drill, countersink'
              ],
              resources: [{ label: 'Starter tool library (.tooldb)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Tool libraries are linked under this lesson’s resources.' },
                { q: 'What should I focus on here?', a: 'Cycle parameters vs material and hole depth.' }
              ]
            }
          ]
        },
        {
          id: 'm3',
          title: 'Module 3 · Verification & Posting',
          lessons: [
            {
              id: 'm3l1',
              title: 'Backplot & Verify',
              dur: '20m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_VERIFY?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Simulate for collisions using stock models',
                'Store verify states for faster iteration'
              ],
              resources: [{ label: 'Verify best practices (PDF)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'See the Verify best practices PDF under resources.' },
                { q: 'What should I focus on here?', a: 'Accurate holder/shank definitions and sensible tolerances.' }
              ]
            },
            {
              id: 'm3l2',
              title: 'Posts & NC Output',
              dur: '15m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_POST?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Select and configure a Fanuc-style post',
                'Preview NC and prepare for DNC transfer'
              ],
              resources: [{ label: 'Generic Fanuc post (.cps)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Use the Fanuc post from resources and match your control definition.' },
                { q: 'What should I focus on here?', a: 'Program numbers, headers/footers, and safety blocks.' }
              ]
            }
          ]
        },
        {
          id: 'm4',
          title: 'Module 4 · Advanced (3+2 / 5‑Axis)',
          lessons: [
            {
              id: 'm4l1',
              title: 'Intro to 3+2',
              dur: '15m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_3P2?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Plan work offsets for set-angle operations',
                'Use Toolplane = Cplane for posting consistency'
              ],
              resources: [{ label: 'Workholding tips (PDF)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Download the workholding tips PDF under resources.' },
                { q: 'What should I focus on here?', a: 'Clear plane naming and collision awareness with fixtures.' }
              ]
            },
            {
              id: 'm4l2',
              title: '5‑Axis Basics',
              dur: '30m',
              embed: `<iframe class="w-full h-full" src="https://web.microsoftstream.com/embed/video/VIDEO_ID_5AX?autoplay=false&showinfo=true" frameborder="0" allowfullscreen></iframe>`,
              objectives: [
                'Understand tool axis control concepts',
                'Apply safe lead/lag angles and rotational limits'
              ],
              resources: [{ label: '5‑axis sample part (STEP)', href: '#' }],
              faqs: [
                { q: 'Where are the support files?', a: 'Use the 5‑axis STEP sample from the resources list.' },
                { q: 'What should I focus on here?', a: 'Safety first—simulate thoroughly and keep limits conservative.' }
              ]
            }
          ]
        }
      ]
    };

    // ===== STATE =====
    const S = { state: 'mastercam.state' };

    // ===== RENDERING =====
    const playlistEl = document.getElementById('playlist');
    function renderPlaylist() {
      playlistEl.innerHTML = '';
      course.modules.forEach((mod) => {
        const modId = `mod-${mod.id}`;
        const wrap = document.createElement('div');
        wrap.className = 'border border-gray-200 dark:border-gray-800 rounded-xl overflow-hidden mb-3';
        wrap.innerHTML = `
          <button class="w-full text-left p-3 bg-gray-50 dark:bg-gray-800/60 flex items-center justify-between" data-acc="${modId}">
            <span class="text-sm font-medium">${mod.title}</span>
            <span class="text-xs text-gray-500">▼</span>
          </button>
          <div id="${modId}" class="p-2 space-y-1 hidden"></div>`;
        playlistEl.appendChild(wrap);
        const body = wrap.querySelector('#' + modId);
        mod.lessons.forEach(lsn => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-base';
          row.innerHTML = `
            <div class="min-w-0">
              <button class="text-sm font-medium underline underline-offset-2" data-play="${lsn.id}">${lsn.title}</button>
              <div class="text-xs text-gray-500">${lsn.dur}</div>
            </div>
            <label class="text-xs flex items-center gap-2"><input type="checkbox" data-done="${lsn.id}" class="rounded"/> Done</label>`;
          body.appendChild(row);
        });
        wrap.querySelector('[data-acc]').addEventListener('click', () => {
          body.classList.toggle('hidden');
        });
      });
    }

    // ===== HELPERS =====
    function allLessons() { return course.modules.flatMap(m => m.lessons); }
    function findLesson(id) {
      for (const m of course.modules) { const l = m.lessons.find(x => x.id === id); if (l) return l; }
      return null;
    }

    // ===== STATE OPS =====
    function getState() { try { return JSON.parse(localStorage.getItem(S.state)) || {}; } catch { return {}; } }
    function setState(next) { localStorage.setItem(S.state, JSON.stringify(next)); updateProgress(); }

    // ===== HYDRATE =====
    function hydrate() {
      const st = getState();
      document.querySelectorAll('[data-done]').forEach(cb => {
        const id = cb.getAttribute('data-done');
        cb.checked = !!(st.completed && st.completed[id]);
        cb.addEventListener('change', () => {
          const s = getState(); s.completed = s.completed || {}; s.completed[id] = cb.checked; setState(s);
        });
      });
      const lsn = currentLesson() || allLessons()[0];
      if (lsn) loadLesson(lsn.id);
    }

    function currentLesson() { const st = getState(); return st.currentLessonId ? findLesson(st.currentLessonId) : null; }
    function setCurrentLesson(id) { const s = getState(); s.currentLessonId = id; setState(s); loadLesson(id); }

    // ===== LOAD LESSON =====
    function loadLesson(id) {
      const lsn = findLesson(id); if (!lsn) return;
      const s = getState(); s.currentLessonId = id; setState(s);
      const mount = document.getElementById('playerMount');
      if (lsn.embed) { mount.innerHTML = lsn.embed; }
      else if (lsn.video) { mount.innerHTML = `<iframe class="w-full h-full" src="${lsn.video}" title="Mastercam lesson" allowfullscreen></iframe>`; }
      document.getElementById('currentLessonLabel').textContent = lsn.title;
      const objList = document.getElementById('objectivesList'); objList.innerHTML = '';
      (lsn.objectives || []).forEach(n => { const li = document.createElement('li'); li.textContent = n; objList.appendChild(li); });
      const resList = document.getElementById('resourceList'); resList.innerHTML = '';
      (lsn.resources || []).forEach(r => { const li = document.createElement('li'); li.innerHTML = `<a class=\"underline\" href=\"${r.href}\" target = "_blank">${r.label}</a>`; resList.appendChild(li); });
      const faqWrap = document.getElementById('faqList');
      if (faqWrap) {
        faqWrap.innerHTML = '';
        const faqs = (LESSON_FAQS[lsn.id] || lsn.faqs || DEFAULT_FAQS);
        faqs.forEach((f, i) => {
          const det = document.createElement('details');
          det.className = 'group' + (i ? ' mt-3' : '');
          det.innerHTML = `<summary class=\"cursor-pointer text-sm font-medium\">${f.q}</summary><p class=\"mt-2 text-sm text-gray-600 dark:text-gray-400\">${f.a}</p>`;
          faqWrap.appendChild(det);
        });
        const faqTitle = document.getElementById('faqLessonTitle');
        if (faqTitle) faqTitle.textContent = '— ' + lsn.title;
      }
      const st2 = getState();
      document.getElementById('notesBox').value = (st2.notes && st2.notes[id]) || '';
      document.getElementById('qaBox').value = st2.qa || '';
      const cb = document.querySelector(`[data-done="${id}"]`);
      if (cb) cb.checked = !!(st2.completed && st2.completed[id]);
      switchTab(st2.lastTab || 'notes');
    }

    // ===== TABS =====
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
      document.getElementById('tab-' + name).classList.remove('hidden');
      const s = getState(); s.lastTab = name; setState(s);
    }

    // ===== NOTES SAVE =====
    document.getElementById('notesBox').addEventListener('input', (e) => {
      const st = getState(); st.notes = st.notes || {}; const cur = currentLesson(); if (cur) { st.notes[cur.id] = e.target.value; setState(st); }
    });
    document.getElementById('qaBox').addEventListener('input', (e) => {
      const st = getState(); st.qa = e.target.value; setState(st);
    });

    // ===== NAV / PROGRESS =====
    document.getElementById('markDone').addEventListener('click', () => {
      const cur = currentLesson(); if (!cur) return;
      const s = getState(); s.completed = s.completed || {}; s.completed[cur.id] = true; setState(s);
      const cb = document.querySelector(`[data-done=\"${cur.id}\"]`); if (cb) cb.checked = true;
      const lessons = allLessons();
      const idx = lessons.findIndex(l => l.id === cur.id);
      if (idx >= 0 && idx < lessons.length - 1) { setCurrentLesson(lessons[idx + 1].id); }
      updateProgress();
    });
    document.getElementById('prevLesson').addEventListener('click', () => {
      const cur = currentLesson() || allLessons()[0];
      const lessons = allLessons();
      const idx = lessons.findIndex(l => l.id === cur.id);
      if (idx > 0) setCurrentLesson(lessons[idx - 1].id);
    });
    document.getElementById('nextLesson').addEventListener('click', () => {
      const cur = currentLesson() || allLessons()[0];
      const lessons = allLessons();
      const idx = lessons.findIndex(l => l.id === cur.id);
      if (idx >= 0 && idx < lessons.length - 1) setCurrentLesson(lessons[idx + 1].id);
    });

    function updateProgress() {
      const lessons = allLessons();
      const s = getState(); const done = s.completed ? Object.values(s.completed).filter(Boolean).length : 0;
      const pct = Math.round((done / lessons.length) * 100);
      document.getElementById('coursePct').textContent = pct + '%';
      document.getElementById('coursePctTop').textContent = pct + '%';
      document.getElementById('courseBar').style.width = pct + '%';
      document.getElementById('downloadCert').disabled = pct < 100;
    }

    // ===== CERTIFICATE =====
    document.getElementById('downloadCert').addEventListener('click', () => {
      const name = prompt('Name to print on certificate:') || 'Learner';
      const html = `<!doctype html><meta charset=\"utf-8\">
<style>body{font-family:Inter,system-ui;margin:40px;background:#f7fafc} .card{max-width:800px;margin:auto;padding:40px;border:2px solid #003A8C;border-radius:24px;background:white} h1{color:#003A8C} .sub{color:#4a5568} .sig{margin-top:48px;display:flex;justify-content:space-between;color:#2d3748}</style>
<div class=card><h1>Certificate of Completion</h1><p class=sub>This certifies that</p><h2 style=\"margin:8px 0 24px\">${name}</h2><p>has successfully completed the <strong>Mastercam Academy</strong> onboarding course.</p><p class=sub>Completed on ${new Date().toLocaleDateString()}</p><div class=sig><div>_____________________<br/>Training Lead</div><div>_____________________<br/>HR / People Ops</div></div></div>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'Mastercam-Certificate.html'; a.click(); URL.revokeObjectURL(url);
    });

    // ===== SELF TESTS =====
    function runSelfTests() {
      const errs = [];
      // 1) unique lesson IDs
      const ids = allLessons().map(l => l.id);
      const dup = ids.find((id, i) => ids.indexOf(id) !== i);
      if (dup) errs.push(`Duplicate lesson id detected: ${dup}`);
      // 2) each lesson has title and either embed or video
      allLessons().forEach((l, i) => {
        if (!l.title) errs.push(`Lesson ${l.id || i} missing title`);
        if (!l.embed && !l.video) errs.push(`Lesson ${l.id} missing embed/video`);
      });
      // 3) FAQ fallback works
      const missingFaq = allLessons().filter(l => !LESSON_FAQS[l.id] && !l.faqs);
      if (missingFaq.length) {
        console.warn('Lessons without explicit FAQs will use DEFAULT_FAQS:', missingFaq.map(l => l.id));
      }
      // 4) No placeholder tokens in course source
      try {
        const s = JSON.stringify(course);
        if (s.includes('$1') || s.includes('$2')) errs.push('Placeholder tokens "$1/$2" still present in course data');
      } catch (e) {
        errs.push('Course could not be serialized');
      }
      // 5) Basic embed sanity (string with <iframe or <div)
      allLessons().forEach(l => {
        if (typeof l.embed !== 'string' || (!l.embed.includes('<iframe') && !l.embed.includes('<div'))) {
          errs.push(`Lesson ${l.id} has unexpected embed markup`);
        }
      });

      if (errs.length) {
        console.error('[Mastercam Academy] Self-tests failed:', errs);
        const warn = document.createElement('div');
        warn.className = 'fixed bottom-4 right-4 bg-red-600 text-white text-sm px-4 py-2 rounded-xl shadow-lg';
        warn.textContent = 'Mastercam Academy: Self-tests failed. Open console for details.';
        document.body.appendChild(warn);
      } else {
        console.log('[Mastercam Academy] All self-tests passed.');
      }
    }

    // ===== INIT =====
    renderPlaylist();
    // Event delegation so clicks work for dynamically-created playlist items
    playlistEl.addEventListener('click', (e) => {
      const playBtn = e.target.closest('[data-play]');
      if (playBtn) {
        e.preventDefault();
        const id = playBtn.getAttribute('data-play');
        if (id) setCurrentLesson(id);
      }
    });

    hydrate();
    updateProgress();
    if (!currentLesson()) setCurrentLesson(allLessons()[0].id);
    runSelfTests();
  </script>
</body>

</html>